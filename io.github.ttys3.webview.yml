id: io.github.ttys3.webview
sdk: org.gnome.Sdk//46
runtime: io.github.ttys3.LarkGtk
runtime-version: master
build-extension: true
appstream-compose: false
build-options:
  prefix: /app/lib/webview
  prepend-pkg-config-path: /app/lib/webview/lib/pkgconfig
  cflags: -g0 -DNDEBUG
  cxxflags: -g0 -DNDEBUG
  strip: true
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/gir-1.0
modules:
  - name: unifdef
    no-autogen: true
    make-install-args:
      - prefix=/app/lib/webview
    sources:
      - type: archive
        url: https://dotat.at/prog/unifdef/unifdef-2.12.tar.xz
        sha256: 43ce0f02ecdcdc723b2475575563ddb192e988c886d368260bc0a63aee3ac400
        x-checker-data:
          type: anitya
          project-id: 5046
          url-template: https://dotat.at/prog/unifdef/unifdef-$version.tar.xz
    cleanup:
      - '*'

  - name: webkitgtk
    buildsystem: cmake-ninja
    build-options:
      no-debuginfo: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DPORT=GTK
      - -DUSE_GTK4=ON
      - -DUSE_LIBBACKTRACE=OFF
      - -DUSE_LIBSECRET=OFF
      - -DUSE_WOFF2=OFF
      - -DENABLE_BUBBLEWRAP_SANDBOX=OFF
      - -DENABLE_GAMEPAD=OFF
      - -DENABLE_INTROSPECTION=OFF
      - -DENABLE_SPELLCHECK=OFF
    make-args:
      - -j 15
    sources:
      - type: git
        url: https://github.com/ttys3/my-fedora-packages.git
        tag: webkitgtk-2.44.2-1
        dest: my-fedora-packages
      - type: archive
        url: https://webkitgtk.org/releases/webkitgtk-2.44.2.tar.xz
        sha256: 523f42c8ff24832add17631f6eaafe8f9303afe316ef1a7e1844b952a7f7521b
        x-checker-data:
          type: html
          url: https://webkitgtk.org/releases/
          version-pattern: LATEST-STABLE-(\d[\.\d]+\d)
          url-template: https://webkitgtk.org/releases/webkitgtk-$version.tar.xz
      - type: shell
        commands:
          - sed -i 's@NAMES avif.h@NAMES avif/avif.h@' Source/cmake/FindAVIF.cmake
          - sed -i '/PATH_SUFFIXES avif/d' Source/cmake/FindAVIF.cmake
          - sed -i 's@${AVIF_INCLUDE_DIR}/avif.h@${AVIF_INCLUDE_DIR}/avif/avif.h@'
            Source/cmake/FindAVIF.cmake
          - patch -p1 < ./my-fedora-packages/src/webkitgtk/PasteboardGtk-legacy-clipboard-image-paste.patch
          - patch -p1 < ./my-fedora-packages/src/webkitgtk/EnlargeObjectSize.patch
          - patch -p1 < ./my-fedora-packages/src/webkitgtk/fix-FileReader-readAsDataURL-can-not-read-blob-issue.patch

  - name: metadata
    buildsystem: simple
    build-commands:
      - install -Dm644 -t ${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - >-
        appstream-compose --origin=flatpak
        --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} ${FLATPAK_ID}
    sources:
      - type: file
        path: io.github.ttys3.webview.metainfo.xml
